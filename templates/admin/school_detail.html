{% extends "admin/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">School Details</h2>
            <a href="/api/admin/schools/manage" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">
                Back to Schools
            </a>
        </div>

        <!-- Database Status Indicators -->
        <div class="mb-8 flex space-x-4">
            <div class="flex-1 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <h3 class="text-sm font-medium text-blue-800">Supabase Database</h3>
                </div>
                <p class="mt-1 text-sm text-blue-600">Data from schools table</p>
            </div>
            <div id="neo4jStatus" class="flex-1 p-4 bg-purple-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="neo4jStatusDot" class="w-3 h-3 bg-gray-300 rounded-full mr-2"></div>
                        <h3 class="text-sm font-medium text-purple-800">Neo4j Database (cc.ccschools)</h3>
                    </div>
                    {% if admin.is_super_admin %}
                    <button onclick="initializeSchoolNode()"
                            class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                        Initialize Node
                    </button>
                    {% endif %}
                </div>
                <p id="neo4jStatusText" class="mt-1 text-sm text-purple-600">Checking node status...</p>
            </div>
        </div>

        <!-- Supabase Data Section -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold">Basic Information (Supabase)</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm font-medium text-gray-500">URN</p>
                    <p class="mt-1">{{ school.urn }}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">Establishment Number</p>
                    <p class="mt-1">{{ school.establishment_number }}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">School Name</p>
                    <p class="mt-1">{{ school.establishment_name }}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">Type</p>
                    <p class="mt-1">{{ school.establishment_type }}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">Type Group</p>
                    <p class="mt-1">{{ school.establishment_type_group }}</p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">Status</p>
                    <p class="mt-1">{{ school.establishment_status }}</p>
                </div>
            </div>
        </div>

        <!-- Contact Information (Supabase) -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold">Contact Information (Supabase)</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm font-medium text-gray-500">Address</p>
                    <p class="mt-1">
                        {{ school.street }}<br>
                        {% if school.locality %}{{ school.locality }}<br>{% endif %}
                        {% if school.address3 %}{{ school.address3 }}<br>{% endif %}
                        {{ school.town }}<br>
                        {% if school.county %}{{ school.county }}<br>{% endif %}
                        {{ school.postcode }}
                    </p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">Contact Details</p>
                    <p class="mt-1">
                        {% if school.telephone_num %}Tel: {{ school.telephone_num }}<br>{% endif %}
                        {% if school.school_website %}
                        Website: <a href="{{ school.school_website }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                            {{ school.school_website }}
                        </a>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Neo4j Node Data Section -->
        <div id="neo4jDataSection" class="mb-8 hidden">
            <div class="flex items-center mb-4">
                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold">School Node Data (Neo4j)</h3>
            </div>
            <div class="p-4 bg-purple-50 rounded-lg">
                <!-- Node Identifiers -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-purple-800 mb-3">Node Identifiers</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Node ID</p>
                            <p id="nodeId" class="mt-1 font-mono text-sm">-</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Node Path</p>
                            <p id="nodePath" class="mt-1 font-mono text-sm">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Node Properties -->
                <div>
                    <h4 class="text-sm font-medium text-purple-800 mb-3">Node Properties</h4>
                    <div id="nodeProperties" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Properties will be populated via JS -->
                        <p class="text-sm text-gray-500">Loading properties...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage File Section -->
        <div id="storageSection" class="mb-8 hidden">
            <div class="flex items-center mb-4">
                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold">Storage File</h3>
            </div>
            <div class="p-4 bg-purple-50 rounded-lg">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-purple-800 mb-3">File Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">File Path</p>
                            <p id="storageFilePath" class="mt-1 font-mono text-sm">-</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Type</p>
                            <p class="mt-1">
                                <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">
                                    application/json
                                </span>
                            </p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">School Name</p>
                            <p class="mt-1 text-sm">{{ school.establishment_name }}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">School URN</p>
                            <p class="mt-1 text-sm">{{ school.urn }}</p>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewFile('{{ school.urn }}/tldraw.json')"
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        View
                    </button>
                    <button onclick="downloadFile('{{ school.urn }}/tldraw.json')"
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download
                    </button>
                    {% if admin.is_super_admin %}
                    <button onclick="deleteFile('{{ school.urn }}/tldraw.json')"
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Graph Database Management -->
        {% if admin.is_super_admin %}
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                <h3 class="text-lg font-semibold">Graph Database Management</h3>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-purple-800 mb-2">Advanced Operations</h4>
                        <p class="text-sm text-gray-600">Manage school node in the graph database</p>
                    </div>
                    <div class="space-y-2">
                        <!-- Placeholder for future functionality -->
                        <button disabled
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-300 cursor-not-allowed">
                            Create School Database
                        </button>
                        <button disabled
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-300 cursor-not-allowed ml-2">
                            Build School
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function formatPropertyValue(value) {
    if (value === null || value === undefined) return '-';
    if (typeof value === 'boolean') return value ? 'Yes' : 'No';
    if (typeof value === 'number') return value.toString();
    if (typeof value === 'string') return value;
    return JSON.stringify(value);
}

function formatPropertyName(name) {
    return name
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

async function initializeSchoolNode() {
    if (!confirm('Are you sure you want to initialize the school node in the graph database?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/schools/{{ school.id }}/initialize-node`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('School node initialized successfully');
            location.reload();
        } else {
            alert('Failed to initialize school node: ' + result.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while initializing school node');
    }
}

async function checkGraphStatus() {
    try {
        const neo4jStatusDot = document.getElementById('neo4jStatusDot');
        const neo4jStatusText = document.getElementById('neo4jStatusText');
        const neo4jDataSection = document.getElementById('neo4jDataSection');
        const storageSection = document.getElementById('storageSection');
        const nodePropertiesDiv = document.getElementById('nodeProperties');
        
        const response = await fetch(`/api/admin/schools/{{ school.id }}/graph-status`);
        const result = await response.json();
        
        if (response.ok) {
            // Update status indicators
            if (result.exists) {
                neo4jStatusDot.className = 'w-3 h-3 bg-purple-500 rounded-full mr-2';
                neo4jStatusText.textContent = 'Node exists in database';
                neo4jDataSection.classList.remove('hidden');
                storageSection.classList.remove('hidden');
                
                // Update node identifiers
                document.getElementById('nodeId').textContent = `School_{{ school.urn }}`;
                document.getElementById('nodePath').textContent = `/schools/cc.ccschools/{{ school.urn }}`;
                document.getElementById('storageFilePath').textContent = `{{ school.urn }}/tldraw.json`;
                
                // Update node properties
                if (result.node_data) {
                    const propertyElements = Object.entries(result.node_data)
                        .filter(([key]) => !['unique_id', 'path'].includes(key))
                        .map(([key, value]) => `
                            <div>
                                <p class="text-sm font-medium text-gray-500">${formatPropertyName(key)}</p>
                                <p class="mt-1 text-sm ${typeof value === 'string' && value.startsWith('http') ? 'text-blue-600 hover:text-blue-800' : 'text-gray-900'}">
                                    ${typeof value === 'string' && value.startsWith('http') 
                                        ? `<a href="${value}" target="_blank">${value}</a>`
                                        : formatPropertyValue(value)}
                                </p>
                            </div>
                        `);
                    nodePropertiesDiv.innerHTML = propertyElements.join('');
                } else {
                    nodePropertiesDiv.innerHTML = '<p class="text-sm text-gray-500">No properties found</p>';
                }
            } else {
                neo4jStatusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full mr-2';
                neo4jStatusText.textContent = 'Node not initialized';
                neo4jDataSection.classList.add('hidden');
                storageSection.classList.add('hidden');
            }
        } else {
            neo4jStatusDot.className = 'w-3 h-3 bg-red-500 rounded-full mr-2';
            neo4jStatusText.textContent = 'Error checking node status';
            neo4jDataSection.classList.add('hidden');
            storageSection.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('neo4jStatusDot').className = 'w-3 h-3 bg-red-500 rounded-full mr-2';
        document.getElementById('neo4jStatusText').textContent = 'Error checking node status';
        document.getElementById('neo4jDataSection').classList.add('hidden');
        document.getElementById('storageSection').classList.add('hidden');
    }
}

// Check status on page load
document.addEventListener('DOMContentLoaded', checkGraphStatus);

// Add the file operation functions
async function viewFile(filePath) {
    try {
        const response = await fetch(`/api/admin/storage/cc.ccschools.public/view/${filePath}`);
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to get file URL');
        }
        
        const data = await response.json();
        window.open(data.url, '_blank');
    } catch (error) {
        console.error('Error viewing file:', error);
        alert('Error viewing file: ' + error.message);
    }
}

async function downloadFile(filePath) {
    try {
        const response = await fetch(`/api/admin/storage/cc.ccschools.public/download/${filePath}`);
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to get file URL');
        }
        
        const data = await response.json();
        window.open(data.url, '_blank');
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Error downloading file: ' + error.message);
    }
}

async function deleteFile(filePath) {
    if (!confirm('Are you sure you want to delete this file?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/storage/cc.ccschools.public/objects/${filePath}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('File deleted successfully');
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to delete file: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file: ' + error.message);
    }
}
</script>
{% endblock %} 