{% extends "admin/base.html" %}

{% block content %}
<div class="p-6">
    <!-- Admin Info -->
    <div class="bg-blue-50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold text-blue-800">Welcome, {{ admin.display_name or admin.email }}</h3>
        <p class="text-sm text-blue-600">
            Role: {{ admin.admin_role }}
            {% if admin.is_super_admin %}
            <span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Super Admin</span>
            {% endif %}
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Quick Actions -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
            <div class="space-y-4">
                <a href="/api/admin/users" class="block w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 text-center">
                    Manage Users
                </a>
                {% if admin.is_super_admin %}
                <a href="/api/admin/admins" class="block w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 text-center">
                    Manage Admins
                </a>
                <a href="/api/admin/schools/manage" class="block w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 text-center">
                    Manage Schools
                </a>
                <a href="/api/admin/storage" class="block w-full bg-indigo-500 text-white py-2 px-4 rounded hover:bg-indigo-600 text-center">
                    Manage Storage
                </a>
                {% endif %}
            </div>
        </div>

        <!-- System Info -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">System Information</h2>
            <div class="space-y-2">
                <p class="text-gray-600">Environment: {{ 'Development' if request.base_url.hostname == 'localhost' else 'Production' }}</p>
                <p class="text-gray-600">Version: {{ app_version }}</p>
                <p class="text-gray-600">Last Updated: {{ admin.updated_at[:19].replace('T', ' ') if admin.updated_at else 'Never' }}</p>
            </div>
        </div>
    </div>

    {% if admin.is_super_admin %}
    <!-- Database Management Section -->
    <div class="mt-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Database Management</h2>

            <!-- Schools Database -->
            <div class="mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-medium mb-2">Schools Database (cc.ccschools)</h3>
                <p class="text-sm text-gray-600 mb-4">Manages school graph data and relationships.</p>

                <!-- Database Status -->
                <div id="schoolsDbStatus" class="mb-4">
                    <p class="text-sm text-gray-600">Checking status...</p>
                </div>

                <!-- Schema Status -->
                <div id="schemaStatus" class="mb-4 p-3 bg-gray-50 rounded">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Schema Status</h4>
                    <div id="schemaDetails" class="text-sm text-gray-600">
                        <p>Checking schema status...</p>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button onclick="initializeSchoolsDatabase()"
                            class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Initialize Schools Database
                    </button>
                    <button onclick="initializeSchema()"
                            class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
                        Initialize Schema
                    </button>
                    <a href="/api/admin/schema"
                       class="inline-flex items-center px-4 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                        View Schema Details
                    </a>
                    <a href="/api/admin/schools/manage"
                       class="inline-flex items-center px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        Manage Schools
                    </a>
                </div>
            </div>

            <!-- Storage Management -->
            <div class="mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-medium mb-2">Storage Management</h3>
                <p class="text-sm text-gray-600 mb-4">Manages storage buckets and policies for user and school files.</p>
                <div id="storageStatus" class="mb-4">
                    <p class="text-sm text-gray-600">Checking status...</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="initializeStorage()"
                            class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Initialize Storage Buckets
                    </button>
                    <a href="/api/admin/storage"
                       class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        <svg class="mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                        </svg>
                        Manage Storage
                    </a>
                </div>
            </div>

            <!-- Users Database (placeholder for future) -->
            <div class="p-4 border rounded-lg bg-gray-50">
                <h3 class="text-lg font-medium mb-2">Users Database (cc.ccusers)</h3>
                <p class="text-sm text-gray-600 mb-4">Will manage user graph data and relationships.</p>
                <p class="text-sm text-yellow-600">Coming soon</p>
            </div>
        </div>
    </div>

    <script>
    async function initializeSchoolsDatabase() {
        if (!confirm('Are you sure you want to initialize the schools database?')) {
            return;
        }

        try {
            const response = await fetch('/api/admin/initialize-schools-database', {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                alert('Schools database initialized successfully');
                checkSchoolsDbStatus();
            } else {
                alert('Failed to initialize schools database: ' + result.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while initializing schools database');
        }
    }

    async function initializeStorage() {
        if (!confirm('Are you sure you want to initialize storage buckets and policies?')) {
            return;
        }

        try {
            const response = await fetch('/api/admin/initialize-storage', {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                const details = result.buckets.map(bucket =>
                    `${bucket.name} (${bucket.id}): ${bucket.status}`
                ).join('\n');

                alert(`Storage initialized successfully!\n\n${details}`);
                checkStorageStatus();
            } else {
                alert('Failed to initialize storage: ' + (result.message || result.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while initializing storage');
        }
    }

    async function initializeSchema() {
        if (!confirm('Are you sure you want to initialize the database schema? This will create all necessary constraints and indexes.')) {
            return;
        }

        try {
            const response = await fetch('/api/admin/initialize-schema', {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                alert('Schema initialized successfully');
                checkSchemaStatus();
            } else {
                alert('Failed to initialize schema: ' + result.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while initializing schema');
        }
    }

    async function checkStorageStatus() {
        try {
            const response = await fetch('/api/admin/check-storage');
            const result = await response.json();

            if (response.ok) {
                const bucketStatus = result.buckets.map(bucket =>
                    `<div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full ${bucket.exists ? 'bg-green-500' : 'bg-red-500'}"></span>
                        <span class="text-sm ${bucket.exists ? 'text-green-600' : 'text-red-600'}">
                            ${bucket.name} (${bucket.id}): ${bucket.exists ? 'Ready' : 'Not initialized'}
                        </span>
                    </div>`
                ).join('');
                
                document.getElementById('storageStatus').innerHTML = `
                    <div class="space-y-2">
                        ${bucketStatus}
                    </div>
                `;
            } else {
                document.getElementById('storageStatus').innerHTML = `
                    <p class="text-sm text-red-600">
                        Error checking storage status: ${result.detail || 'Unknown error'}
                    </p>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('storageStatus').innerHTML = `
                <p class="text-sm text-red-600">
                    Error checking storage status: ${error.message || 'Unknown error'}
                </p>
            `;
        }
    }

    async function checkSchoolsDbStatus() {
        try {
            const response = await fetch('/api/admin/check-schools-database');
            const result = await response.json();

            if (response.ok) {
                document.getElementById('schoolsDbStatus').innerHTML = `
                    <p class="text-sm ${result.exists ? 'text-green-600' : 'text-yellow-600'}">
                        ${result.exists ? 'Database is ready' : 'Database not initialized'}
                    </p>
                `;
            } else {
                document.getElementById('schoolsDbStatus').innerHTML = `
                    <p class="text-sm text-red-600">
                        Error checking database status: ${result.detail}
                    </p>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('schoolsDbStatus').innerHTML = `
                <p class="text-sm text-red-600">
                    Error checking database status
                </p>
            `;
        }
    }

    async function checkSchemaStatus() {
        try {
            const response = await fetch('/api/admin/check-schema');
            const result = await response.json();

            if (response.ok) {
                const schemaStatus = `
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full ${result.constraints_valid ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-sm ${result.constraints_valid ? 'text-green-600' : 'text-red-600'}">
                                Constraints: ${result.constraints_count} registered
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full ${result.indexes_valid ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-sm ${result.indexes_valid ? 'text-green-600' : 'text-red-600'}">
                                Indexes: ${result.indexes_count} registered
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 rounded-full ${result.labels_valid ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-sm ${result.labels_valid ? 'text-green-600' : 'text-red-600'}">
                                Node Labels: ${result.labels_count} registered
                            </span>
                        </div>
                    </div>
                `;

                document.getElementById('schemaDetails').innerHTML = schemaStatus;
            } else {
                document.getElementById('schemaDetails').innerHTML = `
                    <p class="text-sm text-red-600">
                        Error checking schema status: ${result.detail || result.error || 'Unknown error'}
                    </p>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('schemaDetails').innerHTML = `
                <p class="text-sm text-red-600">
                    Error checking schema status: ${error.message || 'Unknown error'}
                </p>
            `;
        }
    }

    // Initialize status checks
    document.addEventListener('DOMContentLoaded', () => {
        checkSchoolsDbStatus();
        checkStorageStatus();
        checkSchemaStatus();
    });
    </script>
    {% endif %}
</div>
{% endblock %} 